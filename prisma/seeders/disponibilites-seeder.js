const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function seedDisponibilites() {
    console.log('üìÖ Cr√©ation des disponibilit√©s des m√©decins...');

    try {
        // R√©cup√©rer tous les m√©decins cr√©√©s avec leurs cliniques
        const medecins = await prisma.medecin.findMany({
            include: {
                user: { select: { nom: true, prenom: true } },
                clinique: { select: { id: true, nom: true } }
            }
        });

        if (medecins.length === 0) {
            throw new Error('Aucun m√©decin trouv√©. Veuillez d\'abord ex√©cuter le seeder des m√©decins.');
        }

        console.log(`üë®‚Äç‚öïÔ∏è ${medecins.length} m√©decin(s) trouv√©(s) pour cr√©er les disponibilit√©s.`);

        // Supprimer les anciennes disponibilit√©s
        const existingDispos = await prisma.disponibilite.count();
        if (existingDispos > 0) {
            console.log(`‚ö†Ô∏è  ${existingDispos} disponibilit√©(s) d√©j√† existante(s). Suppression...`);
            await prisma.disponibilite.deleteMany();
        }

        // Types de consultation disponibles
        const typesConsultation = ['CLINIQUE', 'DOMICILE', 'TELECONSULTATION'];
        
        // Jours de la semaine
        const joursSemaine = ['LUNDI', 'MARDI', 'MERCREDI', 'JEUDI', 'VENDREDI', 'SAMEDI'];
        
        // Cr√©neaux horaires typiques pour chaque type
        const creneauxHoraires = {
            matin: { debut: '08:00', fin: '12:00' },
            apres_midi: { debut: '14:00', fin: '18:00' },
            soir: { debut: '18:00', fin: '20:00' },
            samedi: { debut: '09:00', fin: '15:00' }
        };

        const disponibilitesCreated = [];

        // Pour chaque m√©decin, cr√©er des disponibilit√©s r√©alistes
        for (const medecin of medecins) {
            const medecinDispos = [];

            // D√©terminer les types de consultation que ce m√©decin propose
            const typesDisponibles = [];
            if (medecin.accepteclinique) typesDisponibles.push('CLINIQUE');
            if (medecin.accepteDomicile) typesDisponibles.push('DOMICILE');
            if (medecin.accepteTeleconsultation) typesDisponibles.push('TELECONSULTATION');

            // Pour chaque type de consultation disponible
            for (const typeConsultation of typesDisponibles) {
                
                // G√©n√©rer disponibilit√©s selon le profil du m√©decin
                if (typeConsultation === 'CLINIQUE') {
                    // Consultations en clinique : 5-6 jours par semaine
                    const joursClinice = joursSemaine.slice(0, Math.random() > 0.3 ? 6 : 5);
                    
                    for (const jour of joursClinice) {
                        if (jour === 'SAMEDI') {
                            // Samedi : horaires r√©duits
                            medecinDispos.push({
                                medecinId: medecin.id,
                                jourSemaine: jour,
                                heureDebut: creneauxHoraires.samedi.debut,
                                heureFin: creneauxHoraires.samedi.fin,
                                typeConsultation: typeConsultation,
                                cliniqueId: medecin.cliniqueId,
                                dureeCreneauMinutes: 30,
                                recurrent: true
                            });
                        } else {
                            // Lundi √† Vendredi : matin + apr√®s-midi (ou juste apr√®s-midi)
                            const aMatin = Math.random() > 0.2; // 80% ont le matin
                            const aApresMidi = Math.random() > 0.1; // 90% ont l'apr√®s-midi
                            
                            if (aMatin) {
                                medecinDispos.push({
                                    medecinId: medecin.id,
                                    jourSemaine: jour,
                                    heureDebut: creneauxHoraires.matin.debut,
                                    heureFin: creneauxHoraires.matin.fin,
                                    typeConsultation: typeConsultation,
                                    cliniqueId: medecin.cliniqueId,
                                    dureeCreneauMinutes: 30,
                                    recurrent: true
                                });
                            }
                            
                            if (aApresMidi) {
                                medecinDispos.push({
                                    medecinId: medecin.id,
                                    jourSemaine: jour,
                                    heureDebut: creneauxHoraires.apres_midi.debut,
                                    heureFin: creneauxHoraires.apres_midi.fin,
                                    typeConsultation: typeConsultation,
                                    cliniqueId: medecin.cliniqueId,
                                    dureeCreneauMinutes: 30,
                                    recurrent: true
                                });
                            }
                        }
                    }
                }

                if (typeConsultation === 'DOMICILE') {
                    // Consultations √† domicile : horaires plus flexibles, moins de jours
                    const joursDomicile = joursSemaine.slice(0, Math.floor(Math.random() * 3) + 3); // 3-5 jours
                    
                    for (const jour of joursDomicile) {
                        if (jour !== 'SAMEDI') {
                            // Cr√©neaux pour domicile (g√©n√©ralement apr√®s-midi ou soir)
                            const creneauDomicile = Math.random() > 0.5 ? 'apres_midi' : 'soir';
                            
                            medecinDispos.push({
                                medecinId: medecin.id,
                                jourSemaine: jour,
                                heureDebut: creneauxHoraires[creneauDomicile].debut,
                                heureFin: creneauxHoraires[creneauDomicile].fin,
                                typeConsultation: typeConsultation,
                                cliniqueId: null, // Pas de clinique pour domicile
                                dureeCreneauMinutes: 45, // Plus long pour le domicile
                                recurrent: true
                            });
                        }
                    }
                }

                if (typeConsultation === 'TELECONSULTATION') {
                    // T√©l√©consultations : tr√®s flexibles, souvent en soir√©e
                    const joursTele = joursSemaine; // Tous les jours
                    
                    for (const jour of joursTele) {
                        if (jour === 'SAMEDI') {
                            // Samedi matin seulement
                            medecinDispos.push({
                                medecinId: medecin.id,
                                jourSemaine: jour,
                                heureDebut: '10:00',
                                heureFin: '13:00',
                                typeConsultation: typeConsultation,
                                cliniqueId: null,
                                dureeCreneauMinutes: 20, // Plus courts pour t√©l√©
                                recurrent: true
                            });
                        } else {
                            // Soir√©e pour t√©l√©consultations
                            medecinDispos.push({
                                medecinId: medecin.id,
                                jourSemaine: jour,
                                heureDebut: creneauxHoraires.soir.debut,
                                heureFin: creneauxHoraires.soir.fin,
                                typeConsultation: typeConsultation,
                                cliniqueId: null,
                                dureeCreneauMinutes: 20,
                                recurrent: true
                            });
                        }
                    }
                }
            }

            // Cr√©er les disponibilit√©s pour ce m√©decin
            if (medecinDispos.length > 0) {
                await prisma.disponibilite.createMany({
                    data: medecinDispos
                });
                
                disponibilitesCreated.push({
                    medecin: `Dr ${medecin.user.prenom} ${medecin.user.nom}`,
                    clinique: medecin.clinique?.nom || 'N/A',
                    disponibilites: medecinDispos.length,
                    types: [...new Set(medecinDispos.map(d => d.typeConsultation))]
                });
            }
        }

        console.log('‚úÖ Disponibilit√©s cr√©√©es avec succ√®s !');
        console.log('');
        console.log('üìã R√©capitulatif des disponibilit√©s :');
        console.log('');

        disponibilitesCreated.forEach(item => {
            console.log(`üë®‚Äç‚öïÔ∏è ${item.medecin}`);
            console.log(`   Clinique      : ${item.clinique}`);
            console.log(`   Disponibilit√©s: ${item.disponibilites} cr√©neaux`);
            console.log(`   Types         : ${item.types.join(', ')}`);
            console.log('');
        });

        // Statistiques globales
        const totalDispos = await prisma.disponibilite.count();
        const statsTypes = await prisma.disponibilite.groupBy({
            by: ['typeConsultation'],
            _count: { typeConsultation: true }
        });

        console.log('üìä Statistiques globales :');
        console.log(`   Total disponibilit√©s : ${totalDispos}`);
        statsTypes.forEach(stat => {
            console.log(`   ${stat.typeConsultation.padEnd(15)} : ${stat._count.typeConsultation} cr√©neaux`);
        });
        console.log('');

        return { 
            count: totalDispos,
            parMedecin: disponibilitesCreated
        };

    } catch (error) {
        console.error('‚ùå Erreur lors de la cr√©ation des disponibilit√©s:', error);
        throw error;
    }
}

// Ex√©cuter si appel√© directement
if (require.main === module) {
    seedDisponibilites()
        .then((result) => {
            console.log(`üéâ ${result.count} disponibilit√©(s) cr√©√©e(s) !`);
        })
        .catch((error) => {
            console.error('üí• Erreur fatale:', error);
            process.exit(1);
        })
        .finally(async () => {
            await prisma.$disconnect();
        });
}

module.exports = seedDisponibilites;